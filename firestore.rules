rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      return request.auth.token.email in ['moneynivesh@gmail.com', 'moneynivesh360@gmail.com'];
    }

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Users can only read/write their own data
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      // Allow user to create their own doc, and admin to update any
      allow write: if (request.auth.uid == userId && request.method == 'create') || (isAdmin() && request.method == 'update');
    }
    
    match /userDetails/{userId} {
        allow read: if request.auth.uid == userId || isAdmin();
        // Allow user to write their own details, and admin to write any
        allow write: if request.auth.uid == userId || isAdmin();
    }

    match /userBalances/{userId} {
      // Allow user to read their own balance, and admin to read any
      allow read: if request.auth.uid == userId || isAdmin();
      // No one can update the balance from the client side. It must be updated via transactions.
      allow write: if false;
    }
    
    match /balanceHistory/{docId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      // Balance history is only created via transactions, not directly by clients.
      allow write: if false;
    }
    
    match /investments/{investmentId} {
        allow read: if resource.data.userId == request.auth.uid || isAdmin();
        // Investments are only created and updated via transactions by admin.
        allow write: if false;
    }

    // Requests: users can create, and read their own. Admin can do anything else.
    match /investmentRequests/{requestId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /fdWithdrawalRequests/{requestId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /topupRequests/{requestId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /balanceWithdrawalRequests/{requestId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /maturedFdRequests/{requestId} {
        allow read: if isAdmin();
        // Only created via server-side logic
        allow write: if false;
    }

    // Public, admin-writable collections
    match /templates/{templateId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    
    match /settings/{settingId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
  }
}